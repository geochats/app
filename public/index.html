<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Митинг.Линк</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css"
          type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">

</head>

<body>
<div id="map" class="map" style="width:100%;height:100%;position:fixed"></div>
<button id="helpButton" class="button is-danger" style="top:.5em;right:.5em;position:fixed">?</button>
<div id="helpModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <div class="container">
                <div class="content">
                    <h1 class="title">???</h1>
                    <h3 class="subtitle">Чтобы добавить одиночный пикет</h3>
                    <ul>
                        <li>перейдите по ссылке и включите бота <a href="https://t.me/miting_link_bot">@miting_link_bot</a></li>
                        <li>отправьте боту сообщение <code>/location широта, долгота</code></li>
                    </ul>

                    <h3 class="subtitle">Чтобы добавить групповой митинг</h3>
                    <ul>
                        <li>для создания митинга, нужна публичная группа в телеграмме</li>
                        <li>добавьте бота <code>@miting_link_bot</code> в группу</li>
                        <li>отправьте из группы сообщение боту <code>/location@miting_link_bot широта, долгота</code></li>
                    </ul>

                    <p>Если вы не знаете широты и долготы, то отправьте боту локацию (работает только на телефонах).</p>
                </div>
            </div>
        </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
</div>
<div id="joinModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <article class="media">
                <div class="media-content">
                    <div class="content">
                        <h1 id="joinTitle" class="title"></h1>
                        <p><span id="joinCount"></span> members</p>
                        <p id="joinDesc"></p>
                        <a id="joinLink" class="button is-danger">Join</a>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
</div>
<div id="pointModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <article class="media">
                <div class="media-content">
                    <div class="content">
                        <p class="image is-square">
                            <img id="pointImage" class="has-ratio"
                                 style="max-width:100%;width:auto;max-height:100%;height:auto;" alt=""/>
                        </p>
                        <p id="pointDesc"></p>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
</div>

<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList"></script>
<script src="https://cdn.jsdelivr.net/npm/fetch-polyfill@0.8.2/fetch.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
<script type="text/javascript">
    const initialCoords = [88.78367097860782, 60.317092090457066];

    loadData().then(function (data) {
        const groupsVector = buildGroupsFeatures(data.groups);
        const pointsVector = buildPointsFeatures(data.points);
        const map = new ol.Map({
            controls: [
                new ol.control.Zoom(),
                new ol.control.ScaleLine(),
                new ol.control.MousePosition({
                    coordinateFormat: ol.coordinate.createStringXY(4),
                    projection: 'EPSG:4326',
                    undefinedHTML: '&nbsp;'
                })
            ],
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: "https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png"
                    }),
                }),
                groupsVector,
                pointsVector
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat(initialCoords),
                zoom: 4
            })
        });


        // map.on('pointermove', function (evt) {
        //     var feature = map.forEachFeatureAtPixel(evt.pixel, function (feat, layer) {
        //             return feat;
        //         }
        //     );
        //
        //     console.log(feature, feature.get('type'));
        // });

        map.on('singleclick', function (evt) {
            let found = false;
            // pointsVector.getFeatures(evt.pixel).then(function (features) {
            //     if (features.length) {
            //         showPointModal(features[0].get('group'))
            //         found = true;
            //     }
            // });
            groupsVector.getFeatures(evt.pixel).then(function (features) {
                if (features.length) {
                    showJoinModal(features[0].get('group'))
                    found = true;
                }
            });
        });
    })

    byId('helpButton').onclick = showHelpModal;

    Array.from(byClass("modal-close")).forEach(element => {
        element.onclick = hideModals;
    });
    Array.from(byClass("modal-background")).forEach(element => {
        element.onclick = hideModals;
    });

    function buildGroupsFeatures(groups) {
        return new ol.layer.Vector({
            source: new ol.source.Vector({
                features: groups.map(function (m) {
                    const f = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([m.longitude, m.latitude])));
                    f.set("group", m);
                    f.setStyle(new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius(m.count),
                            stroke: new ol.style.Stroke({color: '#fff'}),
                            fill: new ol.style.Fill({color: '#f14668'})
                        }),
                        text: new ol.style.Text({
                            font: "12px sans-serif",
                            text: m.count.toString(),
                            fill: new ol.style.Fill({color: '#fff'})
                        }),
                        zIndex: m.count
                    }));
                    return f;
                })
            })
        });
    }

    function buildPointsFeatures(points) {
        return new ol.layer.Vector({
            source: new ol.source.Vector({
                features: points.map(function (m) {
                    const f = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([m.longitude, m.latitude])));
                    f.set("group", m);
                    f.setStyle(new ol.style.Style({
                        image: new ol.style.Icon({
                            opacity: 1,
                            src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red" width="24px" height="18px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20.75 6.99c-.14-.55-.69-.87-1.24-.75-2.38.53-5.03.76-7.51.76s-5.13-.23-7.51-.76c-.55-.12-1.1.2-1.24.75-.14.56.2 1.13.75 1.26 1.61.36 3.35.61 5 .75v12c0 .55.45 1 1 1s1-.45 1-1v-5h2v5c0 .55.45 1 1 1s1-.45 1-1V9c1.65-.14 3.39-.39 4.99-.75.56-.13.9-.7.76-1.26zM12 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>',
                            scale: 1
                        })
                    }));
                    return f;
                })
            })
        });
    }

    function byId(id) {
        return document.getElementById(id);
    }

    function byClass(cl) {
        return document.getElementsByClassName(cl);
    }

    function loadData() {
        return fetch('/list', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then((response) => response.json())
            .then((json) => json.data)
            .catch((error) => {
                console.error(error);
            });
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }

    function radius(count) {
        return 10 + Math.log(count) * 3;
    }

    function showHelpModal() {
        byId('helpModal').classList.add("is-active");
    }

    function showJoinModal(data) {
        byId('joinTitle').innerHTML = data.title;
        byId('joinCount').innerHTML = data.count;
        byId('joinDesc').innerHTML = data.description.replace(/(?:\r\n|\r|\n)/g, '<br>');
        byId('joinLink').href = data.link;
        byId('joinModal').classList.add("is-active");
    }

    function showPointModal(data) {
        console.log(data);
        byId('pointDesc').innerHTML = data.description.replace(/(?:\r\n|\r|\n)/g, '<br>');
        byId('pointImage').src = data.photo.Path;
        byId('pointModal').classList.add("is-active");
    }

    function hideModals() {
        Array.from(byClass("modal")).forEach(element => {
            element.classList.remove("is-active");
        });
    }
</script>

</body>

</html>