<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css"
          type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">

</head>

<body>
<div id="map" class="map" style="width:100%;height:100%;position:fixed"></div>
<div id="addModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <div class="container">
                <h1 class="title">Добавление группы</h1>
                <fieldset disabled>
                    <div class="field">
                        <label class="label" for="addModalCoords">Координаты</label>
                        <div class="control">
                            <input id="addModalCoords" class="input" type="text" value="33.31231321, 55.1321312321">
                        </div>
                    </div>
                </fieldset>
                <div class="field">
                    <label class="label" for="addModalLink">Ссылка на чат</label>
                    <div class="control">
                        <input id="addModalLink" class="input" type="text" placeholder="t.me/">
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button id="addModalSave" class="button is-link">Получить код</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
</div>
<div id="joinModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <article class="media">
                <div class="media-content">
                    <div class="content">
                        <h1 id="joinTitle" class="title"></h1>
                        <p><span id="joinCount"></span> участников</p>
                        <p id="joinDesc"></p>
                        <a id="joinLink" class="button is-danger">Присоединиться</a>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
</div>

<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
<script type="text/javascript">
    const initialCoords = [88.78367097860782, 60.317092090457066];
    let addModalCoords;

    loadGroups().then(function (groups) {
        const vector = buildMarkers(groups);
        const map = new ol.Map({
            controls: [
                new ol.control.Zoom(),
                new ol.control.ScaleLine()
            ],
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        //url: "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png"
                        url: "https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png"
                        //url: "http://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"
                    }),
                }),
                vector
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat(initialCoords),
                zoom: 4
            })
        });

        // map.on('pointermove', function (evt) {
        //     var feature = map.forEachFeatureAtPixel(evt.pixel, function (feat, layer) {
        //             return feat;
        //         }
        //     );
        //
        //     console.log(feature, feature.get('type'));
        // });

        map.on('singleclick', function (evt) {
            vector.getFeatures(evt.pixel).then(function (features) {
                const feature = features[0];
                if (features.length) {
                    showJoinModal(feature.get('group'))
                } else {
                    addModalCoords = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326')
                    byId('addModalCoords').value = addModalCoords;
                    byId('addModal').classList.add("is-active");
                }
            });
        });
    })

    byId('addModalSave').onclick = function () {
        const link = byId('addModalLink').value;
        if (!link) {
            return;
        }
        fetch('/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                coords: addModalCoords,
                link: link
            })
        })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    };

    Array.from(byClass("modal-close")).forEach(element => {
        element.onclick = hideModals;
    });
    Array.from(byClass("modal-background")).forEach(element => {
        element.onclick = hideModals;
    });

    function buildMarkers(groups) {
        return new ol.layer.Vector({
            source: new ol.source.Vector({
                features: groups.map(function (m) {
                    const f = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(m.coords)));
                    f.set("group", m);
                    f.setStyle(new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius(m.count),
                            stroke: new ol.style.Stroke({color: '#fff'}),
                            fill: new ol.style.Fill({color: '#f14668'})
                        }),
                        text: new ol.style.Text({
                            font: "12px sans-serif",
                            text: m.count.toString(),
                            fill: new ol.style.Fill({color: '#fff'})
                        }),
                        zIndex: m.count
                    }));
                    return f;
                })
            })
        });
    }

    function byId(id) {
        return document.getElementById(id);
    }

    function byClass(cl) {
        return document.getElementsByClassName(cl);
    }

    function loadGroups() {
        return fetch('/list', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then((response) => response.json())
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }

    function radius(count) {
        return 10 + Math.log(count) * 3;
    }

    function showAddModal(coords) {
        byId('addModalCoords').value = coords;
        byId('addModal').classList.add("is-active");
    }

    function showJoinModal(data) {
        byId('joinTitle').innerHTML = data.title;
        byId('joinCount').innerHTML = data.count;
        byId('joinDesc').innerHTML = data.description.replace(/(?:\r\n|\r|\n)/g, '<br>');
        byId('joinLink').href = data.link;
        byId('joinModal').classList.add("is-active");
    }

    function hideModals() {
        Array.from(byClass("modal")).forEach(element => {
            element.classList.remove("is-active");
        });
    }
</script>

</body>

</html>